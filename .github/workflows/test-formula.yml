name: Test Formula

on:
  pull_request:
    branches:
      - main  # Only run on PRs targeting main
  push:
    branches:
      - main  # Run when changes are pushed/merged to main
  workflow_dispatch:  # Allow manual trigger

jobs:
  test:
    runs-on: macos-latest  # Use macOS runner since we're testing Homebrew
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}  # Checkout PR branch

      - name: Update Homebrew
        run: brew update

      - name: Set up Homebrew tap
        run: |
          # Remove existing tap if it exists
          brew untap console-table-printer/homebrew-console-table || true
          # Add tap from PR branch
          brew tap console-table-printer/homebrew-console-table "${PWD}"

      - name: Validate formula
        run: |
          # Check if formula is valid
          brew audit --strict --online console-table-printer/homebrew-console-table/ctp
          brew style console-table-printer/homebrew-console-table/ctp

      - name: Install formula
        run: |
          # Force reinstall to ensure we're testing the PR version
          brew install --verbose --force-bottle=false console-table-printer/homebrew-console-table/ctp

      - name: Test basic functionality
        run: |
          # Print installed version
          brew info ctp
          
          # Test help command
          ctp --help
          
          # Test actual table printing with sample JSON
          echo '[{"name":"John","age":30},{"name":"Jane","age":25}]' | ctp
          
          # Test version command
          ctp --version

      - name: Cleanup
        if: always()  # Run even if previous steps fail
        run: |
          brew uninstall ctp || true
          brew untap console-table-printer/homebrew-console-table || true 